<!DOCTYPE HTML>
<html>
	<head>
	<title>Footwear - Free Bootstrap 4 Template by Colorlib</title>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	
	<!-- Animate.css -->
	<link rel="stylesheet" href="css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="css/icomoon.css">
	<!-- Ion Icon Fonts-->
	<link rel="stylesheet" href="css/ionicons.min.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="css/bootstrap.min.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="css/magnific-popup.css">

	<!-- Flexslider  -->
	<link rel="stylesheet" href="css/flexslider.css">

	<!-- Owl Carousel -->
	<link rel="stylesheet" href="css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/owl.theme.default.min.css">
	
	<!-- Date Picker -->
	<link rel="stylesheet" href="css/bootstrap-datepicker.css">
	<!-- Flaticons  -->
	<link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="css/style.css">

	</head>
	<body>
		
	<div class="colorlib-loader"></div>

    <header>
		<div id="page">
			<nav class="colorlib-nav" role="navigation">
				<div class="top-menu">
					<div class="container">
						<div class="row">
							<div class="col-sm-7 col-md-9">
								<div id="colorlib-logo"><a href="/"><img src="../../images/Screenshot_2024-10-26_152034-removebg-preview.png" style="height:50px; width:170px"></a></div>
							</div>
							<div class="col-sm-5 col-md-3">
							<form action="#" class="search-wrap">
							   <div class="form-group">
								  <input type="search" class="form-control search" placeholder="Search">
								  <button class="btn btn-primary submit-search text-center" type="submit"><i class="icon-search"></i></button>
							   </div>
							</form>
						 </div>
					 </div>
						<div class="row">
							<div class="col-sm-12 text-left menu-1">
								<ul>
									<li><a href="/">Home</a></li>
									<li><a href="/shop">Shop</a></li>
									<li><a href="#">About</a></li>
									<li><a href="#">Contact</a></li>
									<li><a href="/myaccount">My Account</a></li>
								
									<% if (!user) { %>
                                        <li class="cart"><a href="/login">Login / Register</a></li>
                                    <% } else { %>
                                        <li class="cart"><a href="/logout">Logout</a></li>
                                    <% } %>
									
									<li class="cart"><a href="/cart"><i class="icon-shopping-cart"></i> Cart <span id="cart-count" class="badge badge-danger"><%= cartCount %></span></a></li>
								<li class="cart"><a href="/wishlist">Wishlist</a><span id="wishlist-count" class="badge badge-danger"><%= wishlistCount %></span></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<div class="sale">
					<div class="container">
						<div class="row">
							<div class="col-sm-8 offset-sm-2 text-center">
								<div class="row">
									<div class="owl-carousel2">
										<div class="item">
											<div class="col">
												<h3><a href="#">20% off Almost Everything! Use Code: SAMPLE20</a></h3>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</nav>
		</header>

		<div class="breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col">
						<p class="bread"><span><a href="index.html">Home</a></span> / <span>Checkout</span></p>
					</div>
				</div>
			</div>
		</div>

		<form id="placeOrder">
			<input type="hidden" name="userId" id="userId" value="<%= user._id %>">

			<input type="hidden" name="quantity" id="quantity" value="<%= quantity %>">
			<input type="hidden" name="items" id="items" value="<%= JSON.stringify(items) %>">
		<div class="container my-4">
        <div class="row">
            <!-- Shipping Address Section -->
            <div class="col-md-6">
				<% address.forEach((addr, index) => { %>
				<div class="card mb-4">
					<div class="card-body">
                        <div class="mb-3">
                            <p class="mb-1"><%= addr.housename %></p>
                            <p class="mb-1"><%= addr.city %></p>
                            <p class="mb-1"><%= addr.district %></p>
                            <p class="mb-1"><%= addr.state %></p>
                            <p class="mb-1"><%= addr.country %></p>
                            <p class="mb-1"><%= addr.pincode %></p>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input checkedinput" data-id="<%= addr._id %>"  type="radio" name="address">
                        </div>
						<a href="/checkaddress/edit/<%= addr._id %>" class="btn btn-primary edit-profile-btn">Edit</a>
                    </div>
				</div>
				<% }) %>
				<a href="/checkaddress/add/<%= user.id %>" class=" btn btn-primary edit-profile-btn" id="editbtn">Add</a>
				</div>

            <!-- Cart Summary Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Cart Totals</h5>
                        <div class="table-responsive">
                            <table class="table">
								<thead>
									<tr>
										<th>Products</th>
                          <th class="text-end">Total</th>
                            </tr>
									          <% items.forEach(item=>{ %>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="/<%= item.productId.images[0] %>" alt="Art Night" class="me-2" style="width: 50px;">
                                                <div>
                                                   <%= item.productId.name %>
                                                    <br>
                                                    <small class="text-muted">Ã— <%= item.quantity %></small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end"><%= item.productId.offerPrice %></td>
                                    </tr>
									              <% }) %>
                                    <tr>
                                        <td>Shipping</td>
                                        <td class="text-end"><%= shippingCharge %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total</strong></td>
                                        <td class="text-end"><strong id="totalAmount"><%= grandTotal %></strong></td>
										<span id="discountValue" style="display: none;"></span>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
						
						<div>
							<label for="couponCode">Enter Coupon Code:</label>
							<input type="text" id="couponCode" placeholder="Enter coupon code" style="border-radius: 8px;"><span><button type="button" id="removeCouponBtn" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></span>
							<button type="button" id="applyCouponBtn" class="btn btn-primary">Apply Coupon</button>
							<p id="couponMessage" style="color: green;"></p>
						  </div>
						  

							<div class="mt-4">
								<h6>Payment</h6>
								<div class="form-check">
									<input class="form-check-input" type="radio" name="paymentmethod" id="razorpay" value="Razorpay">
									<label class="form-check-label">Razorpay</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" type="radio" name="paymentmethod" id="cod" value="COD" checked>
									<label class="form-check-label">Cash on Delivery</label>
								</div>
							</div>
							<button type="submit" class="btn btn-primary w-100 mt-4">Place Order</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>
		
		<%- include("./layouts/footer") %>
	</div>

	<div class="gototop js-top">
		<a href="#" class="js-gotop"><i class="ion-ios-arrow-up"></i></a>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<!-- jQuery -->
	<script src="js/jquery.min.js"></script>
   <!-- popper -->
   <script src="js/popper.min.js"></script>
   <!-- bootstrap 4.1 -->
   <script src="js/bootstrap.min.js"></script>
   <!-- jQuery easing -->
   <script src="js/jquery.easing.1.3.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Flexslider -->
	<script src="js/jquery.flexslider-min.js"></script>
	<!-- Owl carousel -->
	<script src="js/owl.carousel.min.js"></script>
	<!-- Magnific Popup -->
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/magnific-popup-options.js"></script>
	<!-- Date Picker -->
	<script src="js/bootstrap-datepicker.js"></script>
	<!-- Stellar Parallax -->
	<script src="js/jquery.stellar.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
	<script>
		let selectedAddress = null;
		const checkedinput = document.querySelectorAll(".checkedinput");
		checkedinput.forEach((element)=>{
			element.addEventListener("change", (e)=>{
				element.checked = true;
                if(element.checked){
					selectedAddress = e.target.getAttribute("data-id"); 
				}
            })
		})

		document.getElementById("placeOrder").addEventListener("submit",async(e)=>{
			e.preventDefault()
			let addressId = selectedAddress;
			let userId=document.getElementById("userId").value
			let items = JSON.parse(document.getElementById("items").value);
			let totalAmount =parseFloat( document.getElementById("totalAmount").textContent)
			let quantity = document.getElementById("quantity").value
			let paymentMethod = document.querySelector('input[name="paymentmethod"]:checked').value;
			console.log(paymentMethod);
			let couponCode=document.getElementById("couponCode").value.trim();
			if(paymentMethod==="COD"){
			try {
				const response= await fetch("/placeorder",{
					method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify({
						addressId,
						userId,
						items,
						totalAmount,
						quantity,
						paymentMethod,
						couponCode
					})
				})
					const result = await response.json()
					if(result.success){
						Swal.fire({
							text:result.message,
							icon:"success",
						})
						setTimeout(() => {
						window.location.href = `/ordercomplete`;
					}, 1000);
					}else{
						Swal.fire({
							text:result.message,
              icon:"error",
						})
					}
			} catch (error) {
				console.log(error)
				Swal.fire({
          text:"Failed to place order. Please try again later.",
          icon:"error",
        })
			}
		}else if (paymentMethod === "Razorpay") {
    try {
        const orderResponse = await fetch("/razorpayorder", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                addressId,
                userId,
                items,
                totalAmount,
                quantity,
                paymentMethod,
                couponCode
            })
        });

        const orderResult = await orderResponse.json();

        if (!orderResult.success) {
            return Swal.fire({
                text: orderResult.message,
                icon: "error",
            });
        }

        const options = {
            key: orderResult.razorpayKey,
            amount: orderResult.amount,
            currency: orderResult.currency,
            name: "TAKRUM",
            description: "Order Payment",
            order_id: orderResult.razorpayOrderId,
            handler: async function (response) {
				const { razorpay_payment_id, razorpay_order_id, razorpay_signature } = response;
                const verifyResponse = await fetch("/verifypayment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        razorpay_payment_id: razorpay_payment_id,
                        razorpay_order_id: razorpay_order_id,
                        razorpay_signature: razorpay_signature,
                        addressId,
                        userId,
                        items,
                        totalAmount,
                        paymentMethod: "Razorpay",
                    }),
                });

                const verifyResult = await verifyResponse.json();

				if (verifyResult.success) {
                    Swal.fire({
                        text: verifyResult.message,
                        icon: "success",
                    });
                    setTimeout(() => {
                        window.location.href = "/ordercomplete";
                    }, 1000);
                } else {
                    Swal.fire({
                        text: verifyResult.message || "Payment verification failed.",
                        icon: "error",
                    });
                }
            },
            theme: {
                color: "#3399cc",
            },
        };

        const rzp = new Razorpay(options);
		rzp.on("payment.failed",function (response){
			Swal.fire({
              icon: "info",
              title: "Payment Incomplete",
              text:
                "The payment could not be completed. The order has been placed but payment was not successful. Please try again.",
            }).then((result) => {
              if (result.isConfirmed || result.dismiss === Swal.DismissReason.close) {
                window.location.href = "/myaccountorder";
              }
            });
          });

		rzp.close()
        rzp.open();

    } catch (error) {
        console.error(error);
        Swal.fire({
            text: "Failed to complete payment. Please try again later.",
            icon: "error",
        });
    }
}
		})

</script>
<script>

document.getElementById("applyCouponBtn").addEventListener("click", async () => {
  const couponCode = document.getElementById("couponCode").value.trim();
  const totalAmount = parseFloat(document.getElementById("totalAmount").textContent);
  const discountValue=parseFloat(document.getElementById("discountValue").textContent)
  const message = document.getElementById("couponMessage");
  
  if (!couponCode) {
    Swal.fire({
      text: "Please enter a coupon code",
      icon: "error",
    });
    return;
  }

  try {
    const response = await fetch("/applycoupon", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ couponCode, totalAmount }),
    });

    const data = await response.json();

    if (data.success) {
      const discount = parseFloat(data.discount);
      message.textContent = `You saved ${discount} ruppees`;
      const totalAmountElement = document.getElementById("totalAmount");

      totalAmountElement.textContent = data.finalAmount.toFixed(2);

      if (totalAmountElement.tagName === "INPUT") {
        totalAmountElement.value = data.finalAmount.toFixed(2);
      }


      document.getElementById("applyCouponBtn").disabled = true;
      document.getElementById("couponCode").disabled = true;

      document.getElementById("removeCouponBtn").style.display = 'inline-block'; 

      Swal.fire({
        text: "Coupon applied successfully",
        icon: "success",
      });
    } else {
      Swal.fire({
        text: data.message,
        icon: "error",
      });
    }
  } catch (error) {
    console.error("Error applying coupon:", error);
    Swal.fire({
      text: "Failed to apply coupon. Please try again later.",
      icon: "error",
    });
  }
});

document.getElementById("removeCouponBtn").addEventListener("click", async () => {
  try {
    const response = await fetch("/removecoupon", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    });

    const data = await response.json();

    if (data.success) {
		document.getElementById("couponCode").value=""
      document.getElementById("couponMessage").textContent = "";
      const totalAmountElement = document.getElementById("totalAmount");

      totalAmountElement.textContent = data.originalTotal.toFixed(2);

      if (totalAmountElement.tagName === "INPUT") {
        totalAmountElement.value = data.originalTotal.toFixed(2);
      }

      document.getElementById("applyCouponBtn").disabled = false;
      document.getElementById("couponCode").disabled = false;

      document.getElementById("removeCouponBtn").style.display = 'none';

      Swal.fire({
        text: "Coupon removed successfully",
        icon: "success",
      });
    } else {
      Swal.fire({
        text: data.message,
        icon: "error",
      });
    }
  } catch (error) {
    console.error("Error removing coupon:", error);
    Swal.fire({
      text: "Failed to remove coupon. Please try again later.",
      icon: "error",
    });
  }
});
</script>
	<!-- Main -->
	<script src="js/main.js"></script>
	</body>
</html>

