<!DOCTYPE HTML>
<html>
	<head>
	<title>Footwear - Free Bootstrap 4 Template by Colorlib</title>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

	<!-- Animate.css -->
	<link rel="stylesheet" href="css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="css/icomoon.css">
	<!-- Ion Icon Fonts-->
	<link rel="stylesheet" href="css/ionicons.min.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="css/bootstrap.min.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="css/magnific-popup.css">

	<!-- Flexslider  -->
	<link rel="stylesheet" href="css/flexslider.css">

	<!-- Owl Carousel -->
	<link rel="stylesheet" href="css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/owl.theme.default.min.css">
	
	<!-- Date Picker -->
	<link rel="stylesheet" href="css/bootstrap-datepicker.css">
	<!-- Flaticons  -->
	<link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/style1.css">

	</head>
    <style>
        .container-fluid {
          background-color: #191c24;
          padding-top: 3rem;
          padding-bottom: 3rem;
        }
        .card {
          background-color:#d3d4d5 ;
        }
        .card-header {
          padding: 1rem;
        }
        .dropdown-toggle {
          width: 100%;
        }
        .table {
          margin-bottom: 0;
        }
        .table th, .table td {
          border-top: none;
          border-bottom: 1px solid #dee2e6;
        }
        .table-container, .address-container {
          padding: 1rem;
        } 
        </style>
	<body>
		
	<!-- <div class="colorlib-loader"></div> -->
    <header>
		<div id="page">
			<nav class="colorlib-nav" role="navigation">
				<div class="top-menu">
					<div class="container">
						<div class="row">
							<div class="col-sm-7 col-md-9">
								<div id="colorlib-logo"><a href="/"><img src="../../images/Screenshot_2024-10-26_152034-removebg-preview.png" style="height:50px; width:170px"></a></div>
							</div>
							<div class="col-sm-5 col-md-3">
							<form action="#" class="search-wrap">
							   <div class="form-group">
								  <input type="search" class="form-control search" placeholder="Search">
								  <button class="btn btn-primary submit-search text-center" type="submit"><i class="icon-search"></i></button>
							   </div>
							</form>
						 </div>
					 </div>
						<div class="row">
							<div class="col-sm-12 text-left menu-1">
								<ul>
									<li><a href="/">Home</a></li>
									<li><a href="/shop">Shop</a></li>
									<li><a href="#">About</a></li>
									<li><a href="#">Contact</a></li>
									<li><a href="/myaccount">My Account</a></li>
								
									<% if (!user) { %>
                                        <li class="cart"><a href="/login">Login / Register</a></li>
                                    <% } else { %>
                                        <li class="cart"><a href="/logout">Logout</a></li>
                                    <% } %>
									
									<li class="cart"><a href="/cart"><i class="icon-shopping-cart"></i> Cart <span id="cart-count" class="badge badge-danger"><%= cartCount %></span></a></li>
								    <li class="cart"><a href="/wishlist">Wishlist</a><span id="wishlist-count" class="badge badge-danger"><%= wishlistCount %></span></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<div class="sale">
					<div class="container">
						<div class="row">
							<div class="col-sm-8 offset-sm-2 text-center">
								<div class="row">
									<div class="owl-carousel2">
										<div class="item">
											<div class="col">
												<h3><a href="#">25% off (Almost) Everything! Use Code: Summer Sale</a></h3>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</nav>
		</header>
        <nav id="user-dashboard-nav">
            <div class="dashboard-menu">
                <a href="/myaccount" class="dashboard-link">PROFILE</a>
                <a href="/myaccountorder" class="dashboard-link">ORDERS</a>
                <a href="/address" class="dashboard-link">ADDRESS</a>
                <a href="/updateprofile" class="dashboard-link">UPDATE PROFILE</a>
                <a href="#" class="dashboard-link">WALLET</a>
                <a href="/logout" id="logout-button">LOGOUT</a>
            </div>
        </nav>

        <div class="row">
            <!-- Product Table -->
            <div class="col-md-8 table-container" >
                <div class="card" >
                    <div class="card-body" >
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr style="background-color:#191c24">
                                        <th>Image</th>
                                        <th>Product Name</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                  <% order.orderItems.forEach((item) => { %>
                                    <tr>
                                        <input type="hidden" id="orderid" value="<%= order._id %>">
                                        <td>
                                        <img src="/<%= item.productId.images[0] %>" alt="" style="width: 50px; height: 50px; object-fit: cover;">
                                        </td>
                                        <td><%= item.productId.name %></td>
                                        <td>₹<%= item.productId.offerPrice.toFixed(2) %></td>
                                        <td><%= item.quantity %></td>
                                        <td>₹<%= (item.productId.offerPrice * item.quantity).toFixed(2) %></td>
                                        <td><%= item.itemStatus %></td>
                                        <% if(item.itemStatus ==="Delivered"){ %>
                                        <td> <button class="btn btn-primary btn-sm recoverbtn" data-product-id="<%= item.productId._id %>"> Return</button></td>
                                        <% }else if(item.itemStatus === "Pending" && order.status === "Pending" && item.itemStatus !== "Cancelled"){ %>
                                        <td> <button class="btn btn-danger btn-sm cancelbtn" data-product-id="<%= item.productId._id %>"> Cancel</button></td>
                                        <% }else{ %>
                                        <td> <button class="btn disabled" disabled>No Action</button></td>
                                        <% } %>
                                    </tr>
                                </tbody>
                                <% }) %>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Shipping Address -->
            <div class="col-md-4 address-container">
                <div class="card">
                    <div class="card-body" style="color: black;">
                        <h5 class="card-title">Shipping Address</h5>
                        <p class="card-text">
                           <b> House Name:</b> <%= order.addressId.housename %> <br>
                            <b>City:</b> <%= order.addressId.city %><br>
                            <b>District:</b> <%= order.addressId.district %> <br>
                            <b>State:</b> <%= order.addressId.state %> <br>
                           <b> Country:</b> <%= order.addressId.country %><br>
                           <b> Pin Code:</b> <%= order.addressId.pincode %>
                        </p>
                    </div>
                </div>
            </div>
        </body>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>

const cancelButtons = document.querySelectorAll('.cancelbtn');
cancelButtons.forEach(button => {
    button.addEventListener('click', (event) => {
        const orderId = document.getElementById("orderid").value;
        const productId = event.target.getAttribute('data-product-id');
        
        Swal.fire({
            title: 'Are you sure?',
            text: 'Do you really want to cancel this item?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, cancel it!',
            cancelButtonText: 'No, keep it',
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/cancelitem/${orderId}/${productId}`, {
                        method: 'POST',
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Remove the row of the canceled item
                        event.target.closest('tr').remove();

                        Swal.fire({
                            text: result.message,
                            icon: "success",
                        });
                    } else {
                        Swal.fire({
                            text: result.message,
                            icon: "error",
                        });
                    }
                } catch (error) {
                    console.error("Error canceling the item:", error);
                    Swal.fire({
                        text: "An error occurred. Please try again.",
                        icon: "error",
                    });
                }
            }
        });
    });
});
     </script>
     <script>

const returnButtons = document.querySelectorAll('.recoverbtn');
returnButtons.forEach(button => {
    button.addEventListener('click', async (event) => {
        const orderId = document.getElementById('orderid').value;
        const productId = event.target.getAttribute('data-product-id');
        console.log(orderId,productId)
        const { value: reason } = await Swal.fire({
            title: 'Reason for Return',
            input: 'textarea',
            inputPlaceholder: 'Enter your reason here...',
            showCancelButton: true,
            confirmButtonText: 'Submit',
            cancelButtonText: 'Cancel',
        });

        if (!reason) {
            return;
        }

        try {
            const response = await fetch('/requestitemreturn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ orderId, productId, reason }),
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire('Success', result.message, 'success');
            } else {
                Swal.fire('Error', result.message, 'error');
            }
        } catch (error) {
            console.error('Error requesting return:', error);
            Swal.fire('Error', 'An error occurred. Please try again later.', 'error');
        }
    });
});

     </script>
    </html>